<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Conecta 4 - {{ jugador1 }} vs {{ jugador2 }}</title>
    <link rel="icon" type="image/png" href="{{ url_for('serve_assets', filename='Logo.png') }}">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Silkscreen&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-jugador1: #FF5252;
            --color-jugador2: #4CAF50;
            --color-fondo: #f3f6fa;
            --color-tablero: #1976d2;
            --color-celda: #222;
            --color-texto: #333;
            --color-borde: #222831;
        }
        
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Silkscreen', Arial, sans-serif;
            background: var(--color-fondo);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--color-texto);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 900px;
            margin-bottom: 20px;
            gap: 20px;
        }
        
        .stats-container {
            flex: 1;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 2px solid var(--color-borde);
            min-width: 200px;
        }
        
        .jugador1-stats {
            border-top: 5px solid var(--color-jugador1);
        }
        
        .jugador2-stats {
            border-top: 5px solid var(--color-jugador2);
        }
        
        .stats-title {
            font-size: 1.2em;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px dashed #ddd;
        }
        
        .stat-value {
            font-weight: bold;
        }
        
        .vs-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-width: 100px;
        }
        
        .vs {
            font-size: 2.5em;
            font-weight: bold;
            color: #FF5722;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .nombres-jugadores {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
        }
        
        .nombre-jugador {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            text-align: center;
        }
        
        .jugador1 {
            background-color: rgba(255, 82, 82, 0.2);
            color: var(--color-jugador1);
        }
        
        .jugador2 {
            background-color: rgba(76, 175, 80, 0.2);
            color: var(--color-jugador2);
        }
        
        .turno-actual {
            box-shadow: 0 0 15px currentColor;
            transform: scale(1.05);
        }
        
        #game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }
        #board-labels {
            display: grid;
            grid-template-columns: repeat(7, 64px);
            gap: 6px;
            margin-bottom: 0px;
            width: max-content;
            margin-left: auto;
            margin-right: auto;
            background: var(--color-tablero);
            border-radius: 16px 16px 0 0;
            box-shadow: 0 0 16px rgba(0,0,0,0.5);
            padding: 8px 12px 0 12px;
            position: relative;
            top: 6px;
            z-index: 2;
        }
        .board-label {
            text-align: center;
            font-family: 'Silkscreen', Arial, sans-serif;
            font-weight: bold;
            font-size: 2.2em;
            color: #fff;
            letter-spacing: 2px;
            user-select: none;
            height: 48px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            text-shadow: 2px 2px 0 #1976d2, 0 0 8px #fff, 0 0 2px #222;
            cursor: pointer;
            transition: background 0.15s, color 0.15s, box-shadow 0.15s;
            border-radius: 10px 10px 0 0;
        }
        .board-label:hover {
            background: #fff2;
            color: #ffeb3b;
            box-shadow: 0 2px 8px #1976d2;
        }
        
        #board {
            display: grid;
            grid-template-columns: repeat(7, 64px);
            grid-template-rows: repeat(6, 64px);
            gap: 6px;
            background: var(--color-tablero);
            border-radius: 16px;
            box-shadow: 0 0 16px rgba(0,0,0,0.5);
            padding: 12px 12px 18px 12px;
            position: relative;
        }
        
        .cell {
            width: 64px;
            height: 64px;
            background: radial-gradient(circle at 50% 50%, var(--color-celda) 70%, var(--color-tablero) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: visible;
        }
        
        .piece {
            width: 90px;
            height: 90px;
            position: absolute;
            left: -13px;
            top: -98px;
            z-index: 2;
            transition: top 0.35s cubic-bezier(.2,1.2,.4,1.05),
                        transform 0.18s cubic-bezier(.2,1.2,.4,1.05),
                        filter 0.18s cubic-bezier(.2,1.2,.4,1.05);
            pointer-events: none;
            filter: drop-shadow(0 0 32px #fff) drop-shadow(0 0 24px #ff0) drop-shadow(0 0 16px #fff8);
        }
        
        .piece.placed {
            top: -13px;
            animation: bounce 0.25s 1;
            filter: drop-shadow(0 0 0 rgba(255, 255, 255, 0));
        }
        
        @keyframes bounce {
            0% { transform: scaleY(1) }
            60% { transform: scaleY(1.18) }
            80% { transform: scaleY(0.92) }
            100% { transform: scaleY(1) }
        }
        
        .column-hover {
            position: absolute;
            top: 0;
            width: 80px;
            height: 100%;
            cursor: pointer;
            z-index: 10;
            opacity: 0;
        }
        
        /* Modal de victoria/empate */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            position: relative;
            z-index: 1001;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            animation: modalAppear 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes modalAppear {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .modal-title {
            font-size: 2em;
            margin-bottom: 20px;
            color: #FF5722;
        }
        
        .modal-message {
            font-size: 1.5em;
            margin-bottom: 30px;
        }
        
        .modal-button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .modal-button:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }
        
        /* Efecto de confeti */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: center;
            }
            
            .stats-container {
                width: 100%;
            }
            
            .vs-container {
                margin: 20px 0;
            }
            
            #board {
                grid-template-columns: repeat(7, 50px);
                grid-template-rows: repeat(6, 50px);
                padding: 8px 8px 12px 8px;
            }
            
            .cell {
                width: 50px;
                height: 50px;
            }
            
            .piece {
                width: 70px;
                height: 70px;
                left: -10px;
                top: -78px;
            }
            
            .piece.placed {
                top: -10px;
            }
            
            .column-hover {
                width: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="stats-container jugador1-stats">
            <div class="stats-title">{{ jugador1 }}</div>
            <div class="stat-item">
                <span>Puntuación:</span>
                <span class="stat-value" id="puntuacion1">{{ stats1.Puntuacion if stats1 else 0 }}</span>
            </div>
            <div class="stat-item">
                <span>Ganadas:</span>
                <span class="stat-value" id="ganadas1">{{ stats1.Ganadas if stats1 else 0 }}</span>
            </div>
            <div class="stat-item">
                <span>Empatadas:</span>
                <span class="stat-value" id="empatadas1">{{ stats1.Empatadas if stats1 else 0 }}</span>
            </div>
            <div class="stat-item">
                <span>Perdidas:</span>
                <span class="stat-value" id="perdidas1">{{ stats1.Perdidas if stats1 else 0 }}</span>
            </div>
        </div>
        
        <div class="vs-container">
            <div class="vs">VS</div>
            <div class="nombres-jugadores">
                <div class="nombre-jugador jugador1" id="nombre-jugador1">{{ jugador1 }}</div>
                <div class="nombre-jugador jugador2" id="nombre-jugador2">{{ jugador2 }}</div>
            </div>
        </div>
        
        <div class="stats-container jugador2-stats">
            <div class="stats-title">{{ jugador2 }}</div>
            <div class="stat-item">
                <span>Puntuación:</span>
                <span class="stat-value" id="puntuacion2">{{ stats2.Puntuacion if stats2 else 0 }}</span>
            </div>
            <div class="stat-item">
                <span>Ganadas:</span>
                <span class="stat-value" id="ganadas2">{{ stats2.Ganadas if stats2 else 0 }}</span>
            </div>
            <div class="stat-item">
                <span>Empatadas:</span>
                <span class="stat-value" id="empatadas2">{{ stats2.Empatadas if stats2 else 0 }}</span>
            </div>
            <div class="stat-item">
                <span>Perdidas:</span>
                <span class="stat-value" id="perdidas2">{{ stats2.Perdidas if stats2 else 0 }}</span>
            </div>
        </div>
    </div>
    
    <div id="game-container">
        <div style="display: flex; flex-direction: column; align-items: center; width: 100%;">
            <div style="width:100%; display:flex; justify-content:center; gap:18px; margin-bottom:18px;">
                <button class="modal-button" style="background:#888;" onclick="window.location.href='/'">Volver al menú</button>
                <button class="modal-button" style="background:#ff9800;" onclick="reiniciarPartida()">Reiniciar partida</button>
            </div>
            <div id="board-labels"></div>
            <div id="board"></div>
        </div>
        
    </div>
    
    <!-- Modal de victoria/empate -->
    <div id="resultModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title" id="modalTitle">¡Resultado!</h2>
            <p class="modal-message" id="modalMessage"></p>
        </div>
        <div class="confetti-container" id="confetti"></div>
    </div>
    
    <script>
    const ROWS = 6;
    const COLS = 7;
    const COLUMN_LABELS = ['A', 'B', 'C', 'D', 'E', 'F', 'G'];
    const fichaImgs = [
        '{{ url_for("serve_assets", filename="FichaP.png") }}',
        '{{ url_for("serve_assets", filename="FichaS.png") }}'
    ];
    
    // Inicializar tablero y variables de estado
    let board, currentPlayer;
    let partidaCargada = false;
    let gameActive = true;

    {% if partida_json %}
    partidaCargada = true;
    const datosPartida = JSON.parse('{{ partida_json|tojson|safe }}');
    board = datosPartida.tablero;
    currentPlayer = datosPartida.turno;
    {% else %}
    board = Array.from({length: ROWS}, () => Array(COLS).fill(null));
    currentPlayer = 0;
    {% endif %}

    const boardDiv = document.getElementById('board');
    const boardLabelsDiv = document.getElementById('board-labels');
    const resultModal = document.getElementById('resultModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');

    function renderBoardLabels() {
        boardLabelsDiv.innerHTML = '';
        boardLabelsDiv.style.display = '';
        for (let i = 0; i < COLS; i++) {
            const label = document.createElement('div');
            label.textContent = COLUMN_LABELS[i];
            label.className = 'board-label';
            label.addEventListener('click', () => gameActive && dropPiece(i));
            boardLabelsDiv.appendChild(label);
        }
    }

    function renderBoard() {
        renderBoardLabels();
        boardDiv.innerHTML = '';
        
        // Crear celdas del tablero
        for (let r = 0; r < ROWS; r++) {
            for (let c = 0; c < COLS; c++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.row = r;
                cell.dataset.col = c;
                boardDiv.appendChild(cell);
            }
        }
        
        // Renderizar fichas existentes
        for (let r = 0; r < ROWS; r++) {
            for (let c = 0; c < COLS; c++) {
                if (board[r][c] !== null) {
                    const cell = Array.from(boardDiv.children).find(
                        el => el.classList.contains('cell') && +el.dataset.row === r && +el.dataset.col === c
                    );
                    const piece = document.createElement('img');
                    piece.src = fichaImgs[board[r][c]];
                    piece.className = 'piece placed';
                    cell.appendChild(piece);
                }
            }
        }
        
        // Overlays para click en columnas
        for (let c = 0; c < COLS; c++) {
            const colDiv = document.createElement('div');
            colDiv.className = 'column-hover';
            colDiv.style.left = (c * 70) + 'px';
            colDiv.style.width = '64px';
            colDiv.addEventListener('click', () => gameActive && dropPiece(c));
            boardDiv.appendChild(colDiv);
        }
        
        // Ajustar para móviles
        if (window.innerWidth <= 768) {
            const columns = document.querySelectorAll('.column-hover');
            columns.forEach((col, index) => {
                col.style.left = (index * 56) + 'px';
                col.style.width = '50px';
            });
        }
        
        updateTurnDisplay();
    }
    
    async function dropPiece(col) {
        if (window.PARTIDA_TERMINADA) return;
        
        let row = ROWS - 1;
        while (row >= 0 && board[row][col] !== null) row--;
        if (row < 0) return;
        
        board[row][col] = currentPlayer;
        animatePieceDrop(row, col, currentPlayer);
        await actualizarPartidaEnBD();
        
        if (checkWin(row, col, currentPlayer)) {
            setTimeout(() => {
                const winner = currentPlayer === 0 ? '{{ jugador1 }}' : '{{ jugador2 }}';
                showResult('¡Victoria!', `¡${winner} gana!`, true);
                updateStats(winner, 'win');
            }, 350);
            window.PARTIDA_TERMINADA = true;
            return;
        }
        
        if (checkForDraw()) {
            setTimeout(() => {
                showResult('¡Empate!', 'La partida terminó en empate', false);
                updateStats(null, 'draw');
            }, 350);
            window.PARTIDA_TERMINADA = true;
            return;
        }
        
        currentPlayer = 1 - currentPlayer;
        await actualizarPartidaEnBD();
        updateTurnDisplay();
    }
    
    async function actualizarPartidaEnBD() {
        const params = new URLSearchParams(window.location.search);
        const jugador1 = params.get('jugador1');
        const jugador2 = params.get('jugador2');
        const idPartida = params.get('id_partida');
        const partida = { tablero: board, turno: currentPlayer };
        
        if (idPartida && partidaCargada) {
            // Actualizar partida existente por ID
            await fetch('/api/actualizar_partida_por_id', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    id_partida: idPartida,
                    partida: partida 
                })
            });
        } else if (jugador1 && jugador2) {
            // Actualizar partida actual (como antes)
            await fetch('/api/actualizar_partida', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    jugador1, 
                    jugador2, 
                    partida 
                })
            });
        }
    }
    
    function checkWin(row, col, player) {
    function count(dx, dy) {
        let r = row + dy, c = col + dx, n = 0;
        while (
            r >= 0 && r < ROWS &&
            c >= 0 && c < COLS &&
            (board[r][c] === player || board[r][c] === player.toString()) // Añadido para manejar strings
        ) {
            n++;
            r += dy;
            c += dx;
        }
        return n;
    }
    
    return (
        count(1, 0) + count(-1, 0) >= 3 ||
        count(0, 1) + count(0, -1) >= 3 ||
        count(1, 1) + count(-1, -1) >= 3 ||
        count(1, -1) + count(-1, 1) >= 3
    );
}
    
    function checkForDraw() {
        for (let r = 0; r < ROWS; r++) {
            for (let c = 0; c < COLS; c++) {
                if (board[r][c] === null) {
                    return false;
                }
            }
        }
        return true;
    }
    
    function showResult(title, message, isVictory) {
        gameActive = false;
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        resultModal.style.display = 'flex';
        
        let menuDiv = document.getElementById('menuPostPartida');
        if (!menuDiv) {
            menuDiv = document.createElement('div');
            menuDiv.id = 'menuPostPartida';
            menuDiv.style.marginTop = '20px';
            menuDiv.style.display = 'flex';
            menuDiv.style.justifyContent = 'center';
            menuDiv.style.gap = '20px';
            menuDiv.innerHTML = `
                <button class="modal-button" onclick="jugarDeNuevo()">Jugar de nuevo</button>
                <button class="modal-button" onclick="volverAlMenu()">Volver al menú</button>
            `;
            resultModal.querySelector('.modal-content').appendChild(menuDiv);
        } else {
            menuDiv.style.display = 'flex';
        }
        
        if (isVictory) {
            const confettiSettings = {
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff']
            };
            confetti(confettiSettings);
            
            const duration = 3 * 1000;
            const animationEnd = Date.now() + duration;
            const interval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) {
                    return clearInterval(interval);
                }
                const particleCount = 50 * (timeLeft / duration);
                confetti({
                    ...confettiSettings,
                    particleCount,
                    origin: { x: Math.random(), y: Math.random() * 0.5 + 0.2 }
                });
            }, 250);
        }
    }
    
    function ocultarMenuPostPartida() {
        let menuDiv = document.getElementById('menuPostPartida');
        if (menuDiv) menuDiv.style.display = 'none';
    }
    
    async function terminarPartida() {
    const params = new URLSearchParams(window.location.search);
    const jugador1 = params.get('jugador1');
    const jugador2 = params.get('jugador2');
    const idPartida = params.get('id_partida');
    
    try {
        let response;
        if (idPartida) {
            response = await fetch('/api/terminar_partida_por_id', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ id_partida: idPartida })
            });
        } else if (jugador1 && jugador2) {
            response = await fetch('/api/terminar_partida', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ jugador1, jugador2 })
            });
        }
        
        if (!response || !response.ok) {
            console.error('Error al terminar partida');
        }
    } catch (error) {
        console.error('Error:', error);
    }
}
    
async function reiniciarPartida() {
    const params = new URLSearchParams(window.location.search);
    const jugador1 = params.get('jugador1');
    const jugador2 = params.get('jugador2');
    const idPartida = params.get('id_partida');

    try {
        const response = await fetch('/api/crear_nueva_partida', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                jugador1: jugador1,
                jugador2: jugador2,
                id_partida_original: idPartida
            })
        });

        const data = await response.json();

        if (data.success) {
            // Redirigir a la nueva partida
            window.location.href = `/juego?id_partida=${data.id_partida}&jugador1=${encodeURIComponent(jugador1)}&jugador2=${encodeURIComponent(jugador2)}`;
        } else {
            alert('Error al reiniciar partida: ' + (data.error || 'desconocido'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al reiniciar partida');
    }
}
    
   function jugarDeNuevo() {
    const params = new URLSearchParams(window.location.search);
    const jugador1 = params.get('jugador1');
    const jugador2 = params.get('jugador2');
    const id_partida_actual = params.get('id_partida');

    fetch('/api/crear_nueva_partida', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            jugador1: jugador1,
            jugador2: jugador2,
            id_partida_original: id_partida_actual
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            window.location.href = `/juego?id_partida=${data.id_partida}&jugador1=${encodeURIComponent(jugador1)}&jugador2=${encodeURIComponent(jugador2)}`;
        } else {
            console.error("Error:", data.error || "Error en la respuesta del servidor");
        }
    })
    .catch(error => {
        console.error("Error:", error);
    });
}
    
    async function volverAlMenu() {
        ocultarMenuPostPartida();
        await terminarPartida();
        window.location.href = '/';
    }
    
    async function updateStats(winner, resultType) {
        try {
            let response;
            
            if (resultType === 'win') {
                const loser = winner === '{{ jugador1 }}' ? '{{ jugador2 }}' : '{{ jugador1 }}';
                response = await fetch('/actualizar_estadisticas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ganador: winner, perdedor: loser })
                });
                
                if (response.ok) {
                    if (winner === '{{ jugador1 }}') {
                        document.getElementById('ganadas1').textContent = parseInt(document.getElementById('ganadas1').textContent) + 1;
                        document.getElementById('puntuacion1').textContent = parseInt(document.getElementById('puntuacion1').textContent) + 1;
                        document.getElementById('perdidas2').textContent = parseInt(document.getElementById('perdidas2').textContent) + 1;
                        document.getElementById('puntuacion2').textContent = parseInt(document.getElementById('puntuacion2').textContent) - 1;
                    } else {
                        document.getElementById('ganadas2').textContent = parseInt(document.getElementById('ganadas2').textContent) + 1;
                        document.getElementById('puntuacion2').textContent = parseInt(document.getElementById('puntuacion2').textContent) + 1;
                        document.getElementById('perdidas1').textContent = parseInt(document.getElementById('perdidas1').textContent) + 1;
                        document.getElementById('puntuacion1').textContent = parseInt(document.getElementById('puntuacion1').textContent) - 1;
                    }
                }
            } else if (resultType === 'draw') {
                response = await fetch('/actualizar_empate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jugador1: '{{ jugador1 }}',
                        jugador2: '{{ jugador2 }}'
                    })
                });
                
                if (response.ok) {
                    document.getElementById('empatadas1').textContent = parseInt(document.getElementById('empatadas1').textContent) + 1;
                    document.getElementById('empatadas2').textContent = parseInt(document.getElementById('empatadas2').textContent) + 1;
                }
            }
            
            if (!response.ok) {
                console.error('Error en la respuesta del servidor:', response.status);
            }
        } catch (error) {
            console.error('Error al actualizar estadísticas:', error);
        }
    }
    
    function resetGame() {
        resultModal.style.display = 'none';
        board = Array.from({length: ROWS}, () => Array(COLS).fill(null));
        currentPlayer = 0;
        gameActive = true;
        renderBoard();
    }
    
    function animatePieceDrop(row, col, player) {
        const cell = Array.from(boardDiv.children).find(
            el => el.classList.contains('cell') && +el.dataset.row === row && +el.dataset.col === col
        );
        const piece = document.createElement('img');
        piece.src = fichaImgs[player];
        piece.className = 'piece';
        cell.appendChild(piece);
        
        void piece.offsetWidth;
        piece.classList.add('placed');
    }
    
    function updateTurnDisplay() {
        const jugador1Element = document.getElementById('nombre-jugador1');
        const jugador2Element = document.getElementById('nombre-jugador2');
        
        if (currentPlayer === 0) {
            jugador1Element.classList.add('turno-actual');
            jugador2Element.classList.remove('turno-actual');
        } else {
            jugador1Element.classList.remove('turno-actual');
            jugador2Element.classList.add('turno-actual');
        }
    }
    
    // Inicializar el juego
    renderBoard();

    // Verificar si la partida está terminada
    {% if request.args.get('id_partida') %}
    fetch(`/api/listar_partidas`).then(r=>r.json()).then(partidas=>{
        const id = parseInt(new URLSearchParams(window.location.search).get('id_partida'));
        const partida = partidas.find(p=>p.PartidaID==id);
        if(partida && partida.Estado==="Terminada") {
            window.PARTIDA_TERMINADA = true;
            boardDiv.style.opacity = 0.7;
            boardLabelsDiv.style.opacity = 0.7;
            let aviso = document.createElement('div');
            aviso.textContent = 'Esta partida ya está terminada. Solo puedes verla.';
            aviso.style = 'color:#c00; font-size:1.3em; text-align:center; margin:20px 0 0 0; font-family:inherit;';
            boardDiv.parentNode.insertBefore(aviso, boardDiv.nextSibling);
        }
    });
    {% endif %}
    
    // Manejar redimensionamiento
    window.addEventListener('resize', () => {
        if (window.innerWidth <= 768) {
            const columns = document.querySelectorAll('.column-hover');
            columns.forEach((col, index) => {
                col.style.left = (index * 56) + 'px';
                col.style.width = '50px';
            });
        } else {
            const columns = document.querySelectorAll('.column-hover');
            columns.forEach((col, index) => {
                col.style.left = (index * 70) + 'px';
                col.style.width = '64px';
            });
        }
    });
</script>
</body>
</html>